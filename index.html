<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Comic Book Generator MVP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .setup-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .setup-panel h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: #f0f1ff;
            border-color: #764ba2;
        }

        .file-upload.dragover {
            background: #e8eaff;
            border-color: #667eea;
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin: 20px auto;
            display: block;
            border: 3px solid #333;
        }

        .comic-output {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .comic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .comic-panel {
            background: #f9f9f9;
            border: 4px solid #333;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .comic-panel h3 {
            background: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 14px;
            z-index: 10;
        }

        .panel-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
        }

        .panel-placeholder {
            width: 100%;
            height: 250px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-weight: bold;
        }

        .panel-loading {
            width: 100%;
            height: 250px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .panel-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fff2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .style-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .style-option {
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .style-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .style-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .comic-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 Visual Comic Book Generator</h1>
            <p>Transform your photo into an epic visual comic book adventure!</p>
        </div>

        <div class="setup-panel">
            <h2>🔧 Setup Configuration</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL:</label>
                    <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                </div>
                <div class="form-group">
                    <label for="supabaseKey">Supabase Anon Key:</label>
                    <input type="password" id="supabaseKey" placeholder="Your Supabase anon key">
                </div>
            </div>
            <div class="form-group">
                <label for="hfApiKey">Hugging Face API Key:</label>
                <input type="password" id="hfApiKey" placeholder="Your Hugging Face API key">
            </div>
            <button class="btn" onclick="initializeApp()">Initialize App</button>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="setup-panel">
                <h2>📸 Create Your Visual Comic</h2>
                
                <div class="form-group">
                    <label>Select Comic Style:</label>
                    <div class="style-selector">
                        <div class="style-option selected" data-style="fantasy">
                            🧙‍♂️<br>Fantasy Adventure
                        </div>
                        <div class="style-option" data-style="manga">
                            🎌<br>Manga Style
                        </div>
                        <div class="style-option" data-style="naruto">
                            🥷<br>Ninja Action
                        </div>
                        <div class="style-option" data-style="superhero">
                            🦸‍♂️<br>Superhero
                        </div>
                        <div class="style-option" data-style="scifi">
                            🚀<br>Sci-Fi Epic
                        </div>
                        <div class="style-option" data-style="anime">
                            ⚡<br>Anime Style
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Upload Your Hero Photo:</label>
                    <div class="file-upload" id="fileUpload">
                        <p>📷 Click here or drag & drop your image</p>
                        <p style="font-size: 14px; color: #666; margin-top: 10px;">This person will be the hero of your comic!</p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>
                    <img id="previewImage" class="preview-image" style="display: none;">
                </div>

                <button class="btn" id="generateBtn" onclick="generateVisualComic()" disabled>
                    ✨ Generate Visual Comic Book
                </button>
            </div>

            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <h3>Creating your visual comic book...</h3>
                <p>Generating 5-6 comic panels featuring you as the hero!</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">Initializing...</p>
            </div>

            <div id="comicOutput" class="comic-output" style="display: none;">
                <h2>📚 Your Visual Comic Book</h2>
                <div class="comic-grid" id="comicGrid"></div>
                <button class="btn" onclick="downloadComicImages()">📥 Download All Panels</button>
                <button class="btn" onclick="regeneratePanel()">🔄 Regenerate Random Panel</button>
            </div>
        </div>
    </div>

    <script>
        let supabase;
        let uploadedImage;
        let currentComic;
        let selectedStyle = 'fantasy';

        // Initialize the app with user credentials
        async function initializeApp() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            const hfApiKey = document.getElementById('hfApiKey').value;

            if (!supabaseUrl || !supabaseKey || !hfApiKey) {
                showError('Please fill in all configuration fields');
                return;
            }

            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                localStorage.setItem('hfApiKey', hfApiKey);
                
                const { data, error } = await supabase.from('visual_comics').select('count');
                if (error && error.code !== 'PGRST116') {
                    await createVisualComicsTable();
                }

                document.getElementById('mainApp').style.display = 'block';
                showSuccess('App initialized successfully!');
                
            } catch (error) {
                showError('Failed to initialize app: ' + error.message);
            }
        }

        // Create visual comics table
        async function createVisualComicsTable() {
            console.log('Creating visual_comics table...');
        }

        // Style selector handling
        document.addEventListener('DOMContentLoaded', function() {
            const styleOptions = document.querySelectorAll('.style-option');
            styleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    styleOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStyle = this.dataset.style;
                });
            });

            setupFileUpload();
        });

        // File upload setup
        function setupFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const imageInput = document.getElementById('imageInput');
            const previewImage = document.getElementById('previewImage');
            const generateBtn = document.getElementById('generateBtn');

            fileUpload.addEventListener('click', () => imageInput.click());
            fileUpload.addEventListener('dragover', handleDragOver);
            fileUpload.addEventListener('drop', handleDrop);
            imageInput.addEventListener('change', handleFileSelect);

            function handleDragOver(e) {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            }

            function handleDrop(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            }

            function handleFile(file) {
                if (!file.type.startsWith('image/')) {
                    showError('Please select an image file');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showError('Image must be less than 5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    uploadedImage = file;
                    generateBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // Generate visual comic book
        async function generateVisualComic() {
            if (!uploadedImage) {
                showError('Please upload an image first');
                return;
            }

            const loadingDiv = document.getElementById('loadingDiv');
            const comicOutput = document.getElementById('comicOutput');
            
            loadingDiv.classList.add('show');
            comicOutput.style.display = 'none';

            try {
                updateProgress(10, 'Analyzing hero image...');
                
                // Convert image to base64
                const base64Image = await fileToBase64(uploadedImage);
                
                updateProgress(20, 'Creating story outline...');
                
                // Generate story scenarios for each panel
                const scenarios = generateStoryScenarios(selectedStyle);
                
                updateProgress(30, 'Setting up comic panels...');
                
                // Create comic panel structure
                createComicPanels(scenarios.length);
                
                // Generate each panel
                for (let i = 0; i < scenarios.length; i++) {
                    updateProgress(30 + (i + 1) * (60 / scenarios.length), `Generating panel ${i + 1}...`);
                    await generateComicPanel(i, scenarios[i], base64Image);
                }
                
                updateProgress(95, 'Finalizing comic book...');
                
                // Save to database
                await saveComicToDatabase({
                    style: selectedStyle,
                    scenarios: scenarios,
                    created_at: new Date().toISOString()
                });
                
                updateProgress(100, 'Comic book ready!');
                
                setTimeout(() => {
                    loadingDiv.classList.remove('show');
                    comicOutput.style.display = 'block';
                }, 1000);
                
            } catch (error) {
                showError('Failed to generate comic: ' + error.message);
                loadingDiv.classList.remove('show');
            }
        }

        // Generate story scenarios for different styles
        function generateStoryScenarios(style) {
            const scenarios = {
                fantasy: [
                    "The hero discovers a magical sword in an ancient forest",
                    "Our hero battles a fierce dragon breathing fire",
                    "The hero meets a wise wizard who grants magical powers",
                    "Epic battle against dark forces in a mystical realm",
                    "The hero stands victorious on a mountain peak",
                    "Triumphant return to the kingdom as a legendary hero"
                ],
                manga: [
                    "The hero poses dramatically with intense determination",
                    "Action scene with the hero using special powers",
                    "Emotional moment as the hero faces their greatest fear",
                    "The hero trains intensively to become stronger",
                    "Epic confrontation with glowing energy effects",
                    "Victory pose with cherry blossoms falling around the hero"
                ],
                naruto: [
                    "The hero performs hand signs for a powerful jutsu",
                    "High-speed ninja battle with shadow clones",
                    "The hero meditates to control chakra energy",
                    "Intense ninja fight on rooftops at sunset",
                    "The hero unlocks hidden ninja powers",
                    "Standing proudly in the hidden village as a master ninja"
                ],
                superhero: [
                    "The hero discovers their incredible superpowers",
                    "Flying through the city skyline at night",
                    "Epic battle against a supervillain",
                    "The hero saves innocent people from danger",
                    "Dramatic pose on a skyscraper overlooking the city",
                    "Victory celebration with the city safe once again"
                ],
                scifi: [
                    "The hero pilots a futuristic spacecraft",
                    "Battle against alien invaders with laser weapons",
                    "Exploring a mysterious alien planet",
                    "The hero uses advanced technology to solve problems",
                    "Epic space battle among the stars",
                    "Triumphant return to Earth as a space hero"
                ],
                anime: [
                    "The hero powers up with glowing aura effects",
                    "Dynamic action pose with energy attacks",
                    "Emotional scene with dramatic lighting",
                    "The hero transforms into their ultimate form",
                    "Spectacular finishing move with special effects",
                    "Victory scene with dramatic wind and sparkles"
                ]
            };
            
            return scenarios[style] || scenarios.fantasy;
        }

        // Create comic panel placeholders
        function createComicPanels(count) {
            const comicGrid = document.getElementById('comicGrid');
            comicGrid.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const panel = document.createElement('div');
                panel.className = 'comic-panel';
                panel.innerHTML = `
                    <h3>Panel ${i + 1}</h3>
                    <div class="panel-loading">
                        <div class="panel-spinner"></div>
                        <p>Generating...</p>
                    </div>
                `;
                comicGrid.appendChild(panel);
            }
        }

        // Generate individual comic panel
        async function generateComicPanel(panelIndex, scenario, heroImage) {
            const hfApiKey = localStorage.getItem('hfApiKey');
            
            // Create prompt for image generation
            const stylePrompts = {
                fantasy: "comic book style, fantasy art, medieval fantasy, magical",
                manga: "manga style, black and white comic, Japanese manga art",
                naruto: "naruto anime style, ninja art, action manga",
                superhero: "superhero comic book style, Marvel DC style, dynamic action",
                scifi: "sci-fi comic book, futuristic style, space adventure",
                anime: "anime style, colorful anime art, Japanese animation"
            };
            
            const prompt = `${stylePrompts[selectedStyle]}, ${scenario}, highly detailed, professional comic book art, dynamic pose, dramatic lighting`;
            
            try {
                // For this MVP, we'll use a placeholder service or generate procedural images
                // In production, you'd use DALL-E, Midjourney, or Stable Diffusion
                const imageUrl = await generateComicImage(prompt, heroImage);
                
                // Update the panel with the generated image
                const panels = document.querySelectorAll('.comic-panel');
                const panel = panels[panelIndex];
                const loadingDiv = panel.querySelector('.panel-loading');
                
                const img = document.createElement('img');
                img.className = 'panel-image';
                img.src = imageUrl;
                img.alt = scenario;
                
                panel.replaceChild(img, loadingDiv);
                
            } catch (error) {
                console.error(`Failed to generate panel ${panelIndex}:`, error);
                
                // Show placeholder on error
                const panels = document.querySelectorAll('.comic-panel');
                const panel = panels[panelIndex];
                const loadingDiv = panel.querySelector('.panel-loading');
                
                const placeholder = document.createElement('div');
                placeholder.className = 'panel-placeholder';
                placeholder.innerHTML = `<p>Panel ${panelIndex + 1}<br>${scenario}</p>`;
                
                panel.replaceChild(placeholder, loadingDiv);
            }
        }

        // Generate comic image (placeholder implementation)
        async function generateComicImage(prompt, heroImage) {
            // This is a placeholder implementation
            // In production, you would use:
            // 1. Stable Diffusion API
            // 2. DALL-E API
            // 3. Midjourney API
            // 4. Custom trained model for face consistency
            
            // For now, we'll create a procedural placeholder
            return await createPlaceholderComicImage(prompt);
        }

        // Create placeholder comic image
        async function createPlaceholderComicImage(prompt) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Create comic-style background
                const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                gradient.addColorStop(0, '#FFE4B5');
                gradient.addColorStop(1, '#DDA0DD');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 300);
                
                // Add comic-style border
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.strokeRect(5, 5, 390, 290);
                
                // Add text
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                
                const words = prompt.split(' ').slice(0, 6);
                words.forEach((word, index) => {
                    ctx.fillText(word, 200, 120 + (index * 25));
                });
                
                // Add comic-style effects
                ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(100, 80, 30, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(300, 220, 25, 0, Math.PI * 2);
                ctx.fill();
                
                // Convert to data URL
                resolve(canvas.toDataURL('image/png'));
            });
        }

        // Update progress bar
        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = text;
        }

        // Save comic to database
        async function saveComicToDatabase(comicData) {
            try {
                const { data, error } = await supabase
                    .from('visual_comics')
                    .insert([comicData])
                    .select();

                if (error) {
                    console.warn('Database save failed:', error);
                }
                
                currentComic = comicData;
            } catch (error) {
                console.warn('Database save error:', error);
            }
        }

        // Download all comic panels
        function downloadComicImages() {
            const panels = document.querySelectorAll('.panel-image');
            
            panels.forEach((img, index) => {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `comic-panel-${index + 1}.png`;
                link.click();
            });
            
            showSuccess('All comic panels downloaded!');
        }

        // Regenerate random panel
        async function regeneratePanel() {
            const panels = document.querySelectorAll('.comic-panel');
            const randomIndex = Math.floor(Math.random() * panels.length);
            const scenarios = generateStoryScenarios(selectedStyle);
            
            const panel = panels[randomIndex];
            const currentImage = panel.querySelector('.panel-image, .panel-placeholder');
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'panel-loading';
            loadingDiv.innerHTML = `
                <div class="panel-spinner"></div>
                <p>Regenerating...</p>
            `;
            
            panel.replaceChild(loadingDiv, currentImage);
            
            try {
                const base64Image = await fileToBase64(uploadedImage);
                await generateComicPanel(randomIndex, scenarios[randomIndex], base64Image);
                showSuccess(`Panel ${randomIndex + 1} regenerated!`);
            } catch (error) {
                showError('Failed to regenerate panel');
            }
        }

        // Utility functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showError(message) {
            const existing = document.querySelector('.error');
            if (existing) existing.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existing = document.querySelector('.success');
            if (existing) existing.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>