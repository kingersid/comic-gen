<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Strip Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.0/umd/supabase.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>Comic Strip Generator</h1>
        
        <!-- Configuration Section -->
        <div id="config-section">
            <h2>Configuration</h2>
            <div>
                <label for="supabase-url">Supabase URL:</label>
                <input type="url" id="supabase-url" placeholder="https://your-project.supabase.co" required>
            </div>
            <div>
                <label for="supabase-key">Supabase Anon Key:</label>
                <input type="password" id="supabase-key" placeholder="Your Supabase anon key" required>
            </div>
            <div>
                <label for="hf-api-key">Hugging Face API Key:</label>
                <input type="password" id="hf-api-key" placeholder="Your Hugging Face API key" required>
            </div>
            <button onclick="initializeApp()">Initialize</button>
        </div>

        <!-- Main App Section -->
        <div id="main-app" style="display: none;">
            <h2>Create Comic Strip</h2>
            
            <!-- Story Input -->
            <div>
                <label for="story-input">Story Description:</label>
                <textarea id="story-input" rows="4" cols="50" 
                    placeholder="Describe your comic story (e.g., 'A superhero saves the city from alien invasion')"></textarea>
            </div>

            <!-- Comic Style -->
            <div>
                <label for="comic-style">Comic Style:</label>
                <select id="comic-style">
                    <option value="superhero">Superhero</option>
                    <option value="manga">Manga</option>
                    <option value="cartoon">Cartoon</option>
                    <option value="realistic">Realistic</option>
                    <option value="fantasy">Fantasy</option>
                    <option value="scifi">Sci-Fi</option>
                </select>
            </div>

            <!-- Panel Count -->
            <div>
                <label for="panel-count">Number of Panels:</label>
                <select id="panel-count">
                    <option value="3">3 Panels</option>
                    <option value="4" selected>4 Panels</option>
                    <option value="5">5 Panels</option>
                    <option value="6">6 Panels</option>
                </select>
            </div>

            <!-- Character Image Upload -->
            <div>
                <label for="character-image">Upload Character Image (optional):</label>
                <input type="file" id="character-image" accept="image/*">
                <img id="character-preview" style="max-width: 200px; display: none;">
            </div>

            <button onclick="generateComicStrip()" id="generate-btn">Generate Comic Strip</button>

            <!-- Progress -->
            <div id="progress" style="display: none;">
                <div>Progress: <span id="progress-text">0%</span></div>
                <div id="progress-bar" style="width: 100%; background: #f0f0f0; height: 20px;">
                    <div id="progress-fill" style="width: 0%; background: #4CAF50; height: 100%;"></div>
                </div>
                <div id="status-text">Initializing...</div>
            </div>

            <!-- Comic Output -->
            <div id="comic-output" style="display: none;">
                <h3>Your Comic Strip</h3>
                <div id="comic-panels"></div>
                <button onclick="downloadComicStrip()">Download Comic Strip</button>
                <button onclick="regeneratePanel()">Regenerate Random Panel</button>
                <button onclick="saveComicStrip()">Save to Database</button>
            </div>
        </div>
    </div>

    <script>
        let supabase;
        let hfApiKey;
        let currentComic = null;
        let characterImage = null;

        // Initialize the application
        async function initializeApp() {
            const supabaseUrl = document.getElementById('supabase-url').value;
            const supabaseKey = document.getElementById('supabase-key').value;
            hfApiKey = document.getElementById('hf-api-key').value;

            if (!supabaseUrl || !supabaseKey || !hfApiKey) {
                alert('Please fill in all configuration fields');
                return;
            }

            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                // Test connection and create table if needed
                await initializeDatabase();
                
                // Show main app
                document.getElementById('config-section').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                alert('App initialized successfully!');
                
            } catch (error) {
                alert('Failed to initialize app: ' + error.message);
            }
        }

        // Initialize database table
        async function initializeDatabase() {
            try {
                const { data, error } = await supabase.from('comic_strips').select('count');
                if (error && error.code === 'PGRST116') {
                    // Table doesn't exist, but we can't create it here
                    console.log('comic_strips table not found, will need to be created manually');
                }
            } catch (error) {
                console.log('Database check failed:', error);
            }
        }

        // Handle character image upload
        document.getElementById('character-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    characterImage = e.target.result;
                    const preview = document.getElementById('character-preview');
                    preview.src = characterImage;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Generate comic strip
        async function generateComicStrip() {
            const story = document.getElementById('story-input').value;
            const style = document.getElementById('comic-style').value;
            const panelCount = parseInt(document.getElementById('panel-count').value);

            if (!story.trim()) {
                alert('Please enter a story description');
                return;
            }

            // Show progress
            document.getElementById('progress').style.display = 'block';
            document.getElementById('comic-output').style.display = 'none';
            document.getElementById('generate-btn').disabled = true;

            try {
                updateProgress(10, 'Breaking story into panels...');
                
                // Generate panel descriptions
                const panelDescriptions = await generatePanelDescriptions(story, panelCount, style);
                
                updateProgress(20, 'Setting up comic panels...');
                
                // Create panel structure
                createPanelStructure(panelDescriptions);
                
                // Generate images for each panel
                for (let i = 0; i < panelDescriptions.length; i++) {
                    updateProgress(30 + (i * 50 / panelDescriptions.length), `Generating panel ${i + 1}...`);
                    await generatePanelImage(i, panelDescriptions[i], style);
                }
                
                updateProgress(90, 'Finalizing comic strip...');
                
                // Store comic data
                currentComic = {
                    story,
                    style,
                    panelDescriptions,
                    panelCount,
                    createdAt: new Date().toISOString()
                };
                
                updateProgress(100, 'Comic strip complete!');
                
                // Show output
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                    document.getElementById('comic-output').style.display = 'block';
                    document.getElementById('generate-btn').disabled = false;
                }, 1000);
                
            } catch (error) {
                alert('Failed to generate comic strip: ' + error.message);
                document.getElementById('progress').style.display = 'none';
                document.getElementById('generate-btn').disabled = false;
            }
        }

        // Generate panel descriptions from story
        async function generatePanelDescriptions(story, panelCount, style) {
            // This is a simple implementation - in production you'd use GPT or Claude API
            const baseDescriptions = {
                3: [
                    "Opening scene establishing the setting and main character",
                    "The main conflict or challenge is introduced",
                    "Resolution and conclusion of the story"
                ],
                4: [
                    "Opening scene with the main character in their normal environment",
                    "The inciting incident that starts the adventure",
                    "The main conflict or challenge reaches its peak",
                    "Resolution and happy ending"
                ],
                5: [
                    "Peaceful beginning showing the main character's daily life",
                    "Something unusual happens that disrupts the peace",
                    "The character faces the main challenge or villain",
                    "Intense action scene or climax of the story",
                    "Victory celebration and return to peace"
                ],
                6: [
                    "Introduction of the main character in their world",
                    "A problem or threat is discovered",
                    "The character prepares for the challenge ahead",
                    "First confrontation with the main obstacle",
                    "The climactic battle or final challenge",
                    "Triumphant resolution and new status quo"
                ]
            };

            const templates = baseDescriptions[panelCount];
            const styleModifiers = {
                superhero: "in dynamic superhero comic book style with bold action",
                manga: "in Japanese manga style with dramatic expressions",
                cartoon: "in colorful cartoon style with exaggerated features",
                realistic: "in realistic comic book style with detailed art",
                fantasy: "in fantasy art style with magical elements",
                scifi: "in sci-fi style with futuristic technology"
            };

            return templates.map((template, index) => {
                return `Panel ${index + 1}: ${template}. ${story}. ${styleModifiers[style]}.`;
            });
        }

        // Create panel structure in DOM
        function createPanelStructure(descriptions) {
            const panelsContainer = document.getElementById('comic-panels');
            panelsContainer.innerHTML = '';

            descriptions.forEach((desc, index) => {
                const panel = document.createElement('div');
                panel.className = 'comic-panel';
                panel.id = `panel-${index}`;
                panel.innerHTML = `
                    <h4>Panel ${index + 1}</h4>
                    <div class="panel-content">
                        <div class="loading">Generating...</div>
                    </div>
                    <p class="panel-description">${desc}</p>
                `;
                panelsContainer.appendChild(panel);
            });
        }

        // Generate image for a specific panel
        async function generatePanelImage(panelIndex, description, style) {
            try {
                // Use Hugging Face Inference API for image generation
                const imageUrl = await callHuggingFaceImageAPI(description);
                
                // Update panel with generated image
                const panel = document.getElementById(`panel-${panelIndex}`);
                const content = panel.querySelector('.panel-content');
                content.innerHTML = `<img src="${imageUrl}" alt="Panel ${panelIndex + 1}" style="max-width: 100%; height: auto;">`;
                
            } catch (error) {
                console.error(`Failed to generate panel ${panelIndex}:`, error);
                
                // Show placeholder on error
                const panel = document.getElementById(`panel-${panelIndex}`);
                const content = panel.querySelector('.panel-content');
                content.innerHTML = `<div class="error">Failed to generate image for panel ${panelIndex + 1}</div>`;
            }
        }

        // Call Hugging Face API for image generation
        async function callHuggingFaceImageAPI(prompt) {
            const API_URL = "https://api-inference.huggingface.co/models/runwayml/stable-diffusion-v1-5";
            
            const response = await fetch(API_URL, {
                headers: {
                    'Authorization': `Bearer ${hfApiKey}`,
                    'Content-Type': 'application/json',
                },
                method: 'POST',
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: {
                        negative_prompt: "blurry, low quality, distorted",
                        num_inference_steps: 20,
                        guidance_scale: 7.5
                    }
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        // Update progress bar
        function updateProgress(percentage, status) {
            document.getElementById('progress-text').textContent = `${percentage}%`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('status-text').textContent = status;
        }

        // Download comic strip
        function downloadComicStrip() {
            const panels = document.querySelectorAll('.comic-panel img');
            panels.forEach((img, index) => {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `comic-panel-${index + 1}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            alert('Comic strip panels downloaded!');
        }

        // Regenerate a random panel
        async function regeneratePanel() {
            if (!currentComic) {
                alert('No comic to regenerate');
                return;
            }

            const randomIndex = Math.floor(Math.random() * currentComic.panelDescriptions.length);
            const panel = document.getElementById(`panel-${randomIndex}`);
            const content = panel.querySelector('.panel-content');
            
            content.innerHTML = '<div class="loading">Regenerating...</div>';
            
            try {
                await generatePanelImage(randomIndex, currentComic.panelDescriptions[randomIndex], currentComic.style);
                alert(`Panel ${randomIndex + 1} regenerated!`);
            } catch (error) {
                alert('Failed to regenerate panel');
            }
        }

        // Save comic strip to database
        async function saveComicStrip() {
            if (!currentComic || !supabase) {
                alert('No comic to save or database not initialized');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('comic_strips')
                    .insert([currentComic]);

                if (error) {
                    throw error;
                }

                alert('Comic strip saved to database!');
            } catch (error) {
                alert('Failed to save comic strip: ' + error.message);
            }
        }
    </script>

    <style>
        /* Minimal styling for functionality */
        body { font-family: Arial, sans-serif; margin: 20px; }
        div { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
        input, textarea, select { margin: 5px; padding: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .comic-panel { border: 2px solid #333; margin: 20px 0; padding: 15px; }
        .panel-content { min-height: 200px; text-align: center; background: #f5f5f5; }
        .loading { padding: 50px; color: #666; }
        .error { padding: 50px; color: red; }
        #progress-bar { border: 1px solid #ccc; }
        h1, h2, h3, h4 { color: #333; }
    </style>
</body>
</html>